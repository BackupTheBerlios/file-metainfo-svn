#!/usr/bin/perl
#

use strict;
use FileInfo;
use FileInfo::DB;
use Getopt::Long;

my $keywords;
my $value; 
my $byn=1;
my ($s,$m);
my $ret_name;
my $debug;
my @nokeys;

GetOptions(
	keywords => \$keywords,
	value => \$value,
	name => \$byn,
	filename => \$ret_name,
	measure => \$m,
	debug => \$debug,
	"nokeywords=s" => \@nokeys
);

$s=shift;

die "You must specify a query.\n" unless $s;
my $fdb=new FileInfo::DB( debug => $debug);
my @q;
my @tables;
my @relations;

if ($byn){
	push @q,qq{FILE.FILENAME LIKE "%} . $s . qq{%"};
	push @tables,"FILE";
}
if ($value) {
	push @q,qq{KEYWORDS.VALUE LIKE "\%$s\%"};
	push @tables,"KEYWORDS";
	push @relations,"FILE.ROWID=KEYWORDS.FILE_ID";
}
die "You must specify a query flag. \n" unless @q;
my $t0=Time::HiRes::time if ($m);

my $sql=genquery($s,"FILE.ROWID",\@tables,\@relations,\@q);

my $arrayref=$fdb->exec_sql($sql);
my $tf=Time::HiRes::time if ($m);
warn "TIMES: exec_sql elapsed in " . ($tf - $t0) . " seconds\n" if ($m);

foreach (@$arrayref){
	 my $fi=new FileInfo(@$_);
	 $fi->print_info();
	 print "labels=" . $fi->print_labels() . "\n";
	 print "keywords:\n\t";
	 $fi->print_values("=","\n\t");
	 print "\n";
	 $fi=undef;
}

sub genquery{
	my $keyword=shift;
	my $what=shift;
	my $tbls=shift;
	my $rels=shift; 
	my $query=shift;
	my $sql;

	print "DEBUG: keyword=$keyword what=$what tbls=@$tbls rels=@$rels query=@$query\n" if $debug;
	
	$sql=$sql . "SELECT DISTINCT $what FROM ";
	$sql=$sql . join(',',@$tbls);
	$sql=$sql . " WHERE ";
	if (defined($$rels[0])){
		$sql=$sql . join(' AND ',@$rels) . " AND ";
	}
	if ($query){
		$sql=$sql . "(" . join(' OR ',@$query) . ")\n";
	}
	print "DEBUG: sql={\n $sql }\n" if $debug;
	return $sql
}
